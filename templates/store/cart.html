{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="tt-breadcrumb">
	<div class="container">
		<ul>
			<li><a href="{% url 'home' %}">Home</a></li>
			<li>Cart</li>
		</ul>
	</div>
</div>
<div id="tt-pageContent">
	<div class="container-indent">
			<div class="container">
				<h1 class="tt-title-subpages noborder">SHOPPING CART</h1>
				<div class="row">
					<div class="col-sm-12 col-xl-8">
						<div class="tt-shopcart-table">
							<table>
								<tbody>
								{% for cart_item in cart_items %}
									<tr>
										<td>
											<a href="javascript:void(0)" class="tt-btn-close delete" onclick="delete_item({{  cart_item.id }})"></a>
										</td>
										<td>
											<div class="tt-product-img">
												<img src="{% static 'assets/images/loader.svg' %}" data-src="{{ cart_item.product.images.url }}" alt="">
											</div>
										</td>
										<td>
											<h2 class="tt-title">
												<a href="{{ cart_item.product.get_url }}">{{ cart_item.product.product_name }}</a>
											</h2>
											<ul class="tt-list-parameters">
												<li>
													<div class="tt-price">
													</div>
												</li>
												<li>
													<div class="detach-quantity-mobile"></div>
												</li>
												<li>
													<div class="tt-price subtotal">
													</div>
												</li>
											</ul>
										</td>
										<td>
											<div class="tt-price" id="product-price-{{ cart_item.id }}">
													{{ cart_item.product.price }}
											</div>
										</td>
										<td>
											<div class="detach-quantity-desctope">
												<div class="tt-input-counter style-01">
													<span class="minus-btn" onclick="decrement_quantity({{ cart_item.id }})"></span>
													<input type="text" value="{% if cart_item.quantity > 0 %}{{cart_item.quantity}}{% else %}1{% endif %}" size="50" id="product-qty-{{ cart_item.id }}">
													<span class="plus-btn" onclick="increment_quantity({{ cart_item.id }})"></span>
												</div>
											</div>
										</td>
										<td>
											<div class="tt-price subtotal" id="product-subtotal-{{ cart_item.id }}">
												{{ cart_item.sub_total }}
											</div>
										</td>
									</tr>
								{% endfor %}
								</tbody>
							</table>
							<div class="tt-shopcart-btn">
								<div class="col-left">
									<a class="btn-link" href="#"><i class="icon-e-19"></i>CONTINUE SHOPPING</a>
								</div>
								<div class="col-right">
									<a class="btn-link" href="#"><i class="icon-h-02"></i>CLEAR SHOPPING CART</a>
									<a class="btn-link" href="#"><i class="icon-h-48"></i>UPDATE CART</a>
								</div>
							</div>
						</div>
					</div>
					<div class="col-sm-12 col-xl-4">
							<div class="tt-shopcart-box tt-boredr-large">
								<table class="tt-shopcart-table01">
									<tbody>
										<tr>
											<th>SUBTOTAL</th>
											<td>$324</td>
										</tr>
									</tbody>
									<tfoot>
										<tr>
											<th>GRAND TOTAL</th>
											<td>$324</td>
										</tr>
									</tfoot>
								</table>
								<a href="{% url 'checkout' %}" class="btn btn-lg"><span class="icon icon-check_circle"></span>PROCEED TO CHECKOUT</a>
							</div>
					</div>
				</div>
			</div>
	</div>
</div>
{% endblock %}



{% block scripts %}
{{ block.super }}

<script>

 function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }



function init(cart_id) {
 	context = {
 	   'price':0,
 	   'qty':0,
 	}
 	context['price'] = parseInt( $('#product-price-' + cart_id).text() );
    context['qty'] = parseInt( $('#product-qty-' + cart_id).val() );
    return context;
}




function increment_quantity(item_id) {
	item = init(item_id)
	calculated_price =  item['price'] * (item['qty']+1)
	var qty = item["qty"]+1
	
	console.log(qty)

	csrftoken = getCookie('csrftoken');
	fetch(`http://localhost:8000/api/cart-items/${item_id}/` , {

		method: 'PUT',
		headers: {
  			'Content-type': 'application/json; charset=UTF-8', // Indicates the content
  			"X-CSRFToken": csrftoken,
 		},
		body: JSON.stringify({ "quantity":qty})

	})
	.then(res => res.text())
	.then(res => {	
		// on post success
		$('#product-subtotal-'+item_id).text( calculated_price )
	});

}



function decrement_quantity(item_id) {
	item = init(item_id)
	qty = 1;

	if (item['qty'] == 1) {
		qty = 1
	} else {
		qty = item['qty'] - 1
	}


	csrftoken = getCookie('csrftoken');

	fetch(`http://localhost:8000/api/cart-items/${item_id}/` , {

		method: 'PUT',
		headers: {
  			'Content-type': 'application/json; charset=UTF-8', // Indicates the content
  			"X-CSRFToken": csrftoken,
 		},
		body: JSON.stringify({ "quantity":qty})

	})
	.then(res => res.text())
	.then(res => {	
		// on post success
		//$('#product-subtotal-'+cart_id).text( calculated_price )
	});


}

function delete_item(item_id) {

	csrftoken = getCookie('csrftoken');

	fetch(`http://localhost:8000/api/cart-items/${item_id}/` , {

		method: 'DELETE',
		headers: {
  			'Content-type': 'application/json; charset=UTF-8', // Indicates the content
  			"X-CSRFToken": csrftoken,
 		},

	})
	.then(res => res.text())
	.then(res => {
			console.log(res)
		  //$(this).parent().parent().fadeOut();
	});

}

</script>
{% endblock %}